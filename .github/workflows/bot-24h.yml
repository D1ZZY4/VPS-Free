name: Bot 24 Hours With Auto Backup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  bot-runner:
    runs-on: ubuntu-latest
    timeout-minutes: 1440

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: admin@123
          POSTGRES_DB: telebot
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc python3-dev postgresql-client

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            sleep 3
          done

      - name: Create database if not exists
        env:
          PGPASSWORD: admin@123
        run: |
          psql -h localhost -U postgres -c "CREATE DATABASE telebot;" || true

      - name: Run bot with 2.5h backup cycle
        env:
          PGPASSWORD: admin@123
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          OWNER_ID: ${{ secrets.OWNER_ID }}
        run: |
          #!/bin/bash
          set -e

          INTERVAL=9000   # 2.5 jam
          BACKUP_DIR=backup
          mkdir -p $BACKUP_DIR

          while true; do
            echo "‚ñ∂ Starting bot"
            python -m tg_bot &
            BOT_PID=$!

            echo "‚è≥ Bot running for 2.5 hours"
            sleep $INTERVAL

            echo "‚õî Stopping bot"
            kill $BOT_PID
            wait $BOT_PID 2>/dev/null || true

            TS=$(date +"%Y%m%d_%H%M%S")

            echo "üóÑÔ∏è Backup database"
            pg_dump -h localhost -U postgres telebot > $BACKUP_DIR/db_$TS.sql

            echo "üì¶ Collect logs"
            mkdir -p bundle_$TS
            cp logs.txt bundle_$TS/ 2>/dev/null || true
            cp *.log bundle_$TS/ 2>/dev/null || true
            cp $BACKUP_DIR/db_$TS.sql bundle_$TS/

            tar -czf backup_$TS.tar.gz bundle_$TS

            echo "üì§ Send backup to owner"
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
              -F chat_id="${OWNER_ID}" \
              -F document=@backup_$TS.tar.gz \
              -F caption="üì¶ Backup + Logs\n‚è± $TS"

            echo "‚ôªÔ∏è Restore database"
            psql -h localhost -U postgres telebot < $BACKUP_DIR/db_$TS.sql

            rm -rf bundle_$TS backup_$TS.tar.gz
          done

      - name: Upload logs (failsafe)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs
          path: |
            logs.txt
            *.log
          retention-days: 7