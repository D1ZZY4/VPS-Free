name: Bot 24 Hours With Auto Backup

on:
  schedule:
    - cron: '0 */2 * * *'  # setiap 2 jam
  workflow_dispatch:

jobs:
  bot-runner:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # maksimal 3 jam per run

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: admin@123
          POSTGRES_DB: telebot
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update -o Acquire::Retries=5 -o Acquire::http::Timeout="10"
          sudo apt-get install -y --no-install-recommends gcc python3-dev postgresql-client curl jq

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for PostgreSQL
        run: |
          MAX_TRIES=20
          TRIES=0
          until pg_isready -h localhost -p 5432 -U postgres || [ $TRIES -ge $MAX_TRIES ]; do
            sleep 3
            TRIES=$((TRIES+1))
          done

          if [ $TRIES -ge $MAX_TRIES ]; then
            echo "‚ùå PostgreSQL failed to start"
            exit 1
          fi

      - name: Create database if not exists
        env:
          PGPASSWORD: admin@123
        run: |
          psql -h localhost -U postgres -c "CREATE DATABASE telebot;" || true

      # =========================
      # RESTORE FROM RELEASE
      # =========================
      - name: Restore db.sql & config.ini from GitHub Release (if exists)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PGPASSWORD: admin@123
        run: |
          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/autosave"
          RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" $API_URL)

          if [ -z "$RESPONSE" ] || echo "$RESPONSE" | grep -q '"message": "Not Found"'; then
            echo "‚ÑπÔ∏è Release 'autosave' not found, starting fresh"
            exit 0
          fi

          ASSET_URL_DB=$(echo "$RESPONSE" | jq -r '.assets[]? | select(.name=="db.sql") | .url // empty')
          ASSET_URL_CFG=$(echo "$RESPONSE" | jq -r '.assets[]? | select(.name=="config.ini") | .url // empty')

          if [ -n "$ASSET_URL_DB" ]; then
            echo "‚¨áÔ∏è Restoring db.sql from release"
            curl -L -H "Authorization: token $GH_TOKEN" -H "Accept: application/octet-stream" "$ASSET_URL_DB" -o db.sql
            psql -h localhost -U postgres telebot < db.sql
          else
            echo "‚ÑπÔ∏è No db.sql found, starting fresh"
          fi

          if [ -n "$ASSET_URL_CFG" ]; then
            echo "‚¨áÔ∏è Restoring config.ini from release"
            curl -L -H "Authorization: token $GH_TOKEN" -H "Accept: application/octet-stream" "$ASSET_URL_CFG" -o config.ini
          else
            echo "‚ÑπÔ∏è No config.ini found, starting fresh"
          fi

      # =========================
      # RUN BOT ONCE + BACKUP
      # =========================
      - name: Run bot for 2.5 hours
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          OWNER_ID: ${{ secrets.OWNER_ID }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PGPASSWORD: admin@123
        run: |
          #!/bin/bash
          set -e
          INTERVAL=9000  # 2.5 jam

          echo "‚ñ∂ Starting bot"
          python -m tg_bot &
          BOT_PID=$!

          echo "‚è≥ Bot running for 2.5 hours"
          sleep $INTERVAL

          echo "‚õî Stopping bot"
          kill $BOT_PID
          wait $BOT_PID 2>/dev/null || true

          TS=$(date +"%Y%m%d_%H%M%S")

          echo "üóÑÔ∏è Dump database"
          pg_dump -h localhost -U postgres telebot > db.sql

          echo "üì§ Upload db.sql & config.ini to GitHub Release"
          RELEASE_TAG="autosave"
          RELEASE_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/$RELEASE_TAG)
          RELEASE_ID=$(echo "$RELEASE_JSON" | jq -r '.id')

          if [ "$RELEASE_ID" = "null" ]; then
            RELEASE_ID=$(curl -s -X POST -H "Authorization: token $GH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"tag_name\":\"$RELEASE_TAG\",\"name\":\"Auto Backup\",\"body\":\"Bot autosave\"}" \
              https://api.github.com/repos/${GITHUB_REPOSITORY}/releases | jq -r '.id')
          fi

          for FILE in db.sql config.ini; do
            if [ -f "$FILE" ]; then
              ASSET_EXIST=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID}/assets" | jq -r ".[] | select(.name==\"$FILE\") | .id")
              if [ -n "$ASSET_EXIST" ]; then
                curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/assets/$ASSET_EXIST"
              fi

              curl -s -X POST -H "Authorization: token $GH_TOKEN" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$FILE" \
                "https://uploads.github.com/repos/${GITHUB_REPOSITORY}/releases/${RELEASE_ID}/assets?name=$FILE"
            fi
          done

          echo "üì¶ Send logs to owner"
          tar -czf logs_$TS.tar.gz logs.txt *.log 2>/dev/null || true

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F chat_id="${OWNER_ID}" \
            -F document=@logs_$TS.tar.gz \
            -F caption="üßæ Logs\n‚è± $TS"

          rm -f logs_$TS.tar.gz